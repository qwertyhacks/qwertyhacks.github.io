<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Clean Drive Music Player</title>

  <!-- Inter font for clean UI -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-0: #061019;
      --bg-1: #081424;
      --card: rgba(255,255,255,0.03);
      --muted: #9fb0c8;
      --accent: linear-gradient(90deg,#7c5cff 0%, #3aa1ff 100%);
      --glass: rgba(255,255,255,0.02);
    }
    html,body{height:100%;margin:0;font-family:"Inter",system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:#e8f2ff;background:linear-gradient(180deg,var(--bg-0),var(--bg-1));-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;overflow:hidden}
    /* App layout */
    .app{display:flex;height:100vh;gap:20px;padding:22px;align-items:stretch;box-sizing:border-box}
    /* Sidebar */
    .sidebar{width:320px;min-width:220px;background:linear-gradient(180deg,var(--card), rgba(255,255,255,0.01));border-radius:14px;padding:16px;display:flex;flex-direction:column;box-shadow:0 20px 50px rgba(0,0,0,0.45)}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,#7c5cff,#3aa1ff);display:flex;align-items:center;justify-content:center;font-weight:700;color:white}
    .app-title{font-weight:700;font-size:16px}
    .muted{color:var(--muted);font-size:13px}
    .controls-row{display:flex;gap:10px;margin-top:12px}
    input[type="text"], input[type="search"], textarea{width:100%;padding:9px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:var(--glass);color:inherit;outline:none}
    button{background:linear-gradient(135deg,#7c5cff,#3aa1ff);border:none;color:white;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:600}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.04)}
    .small{padding:6px 8px;font-size:13px}
    .song-list{margin-top:12px;overflow:auto;padding-right:8px;flex:1}
    .song{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;cursor:pointer;transition:background .12s,transform .12s}
    .song:hover{transform:translateY(-3px);background:linear-gradient(90deg, rgba(124,92,255,0.04), rgba(124,92,255,0.02))}
    .song-thumb{width:46px;height:46px;border-radius:8px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;color:var(--muted);font-weight:700}
    .song-meta{flex:1;min-width:0}
    .song-title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .song-sub{font-size:12px;color:var(--muted);margin-top:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .sidebar-footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;font-size:13px}
    /* Main player */
    .main{flex:1;display:flex;align-items:center;justify-content:center}
    .player{width:100%;max-width:900px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:20px;box-shadow:0 30px 60px rgba(0,0,0,0.6);display:flex;flex-direction:column;gap:12px}
    .player-top{display:flex;gap:16px;align-items:center}
    .cover{width:120px;height:120px;border-radius:12px;background:linear-gradient(135deg,#7c5cff,#3aa1ff);display:flex;align-items:center;justify-content:center;font-weight:800;font-size:28px;color:white}
    .info{display:flex;flex-direction:column;gap:6px;min-width:0}
    .track-name{font-weight:800;font-size:20px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .track-artist{color:var(--muted);font-size:13px}
    .waveform{height:130px;border-radius:8px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));overflow:hidden}
    .controls{display:flex;align-items:center;gap:12px;justify-content:center;margin-top:6px}
    .large-btn{background:linear-gradient(135deg,#7c5cff,#3aa1ff);border:none;color:white;padding:12px 18px;border-radius:12px;font-weight:700;cursor:pointer;box-shadow:0 14px 32px rgba(124,92,255,0.12)}
    .small-btn{padding:8px 10px;border-radius:10px;background:var(--glass);border:none;color:inherit;cursor:pointer}
    .progress-wrap{width:100%;margin-top:6px}
    .progress{height:12px;background:rgba(255,255,255,0.03);border-radius:999px;overflow:hidden;cursor:pointer}
    .progress .fill{height:100%;width:0;background:linear-gradient(90deg,#7c5cff,#3aa1ff);transition:width .06s linear}
    .time-row{display:flex;justify-content:space-between;color:var(--muted);font-size:13px;margin-top:6px}
    .small-controls{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-top:12px}
    label{font-size:13px;color:#dfecff;display:flex;flex-direction:column;gap:8px}
    input[type="range"]{width:220px}
    .right-actions{display:flex;gap:8px;align-items:center}
    /* cursor + trail */
    .cursor-dot{position:fixed;top:0;left:0;width:12px;height:12px;border-radius:50%;background:radial-gradient(circle at 30% 30%, #fff, #7c5cff);box-shadow:0 10px 28px rgba(124,92,255,0.14);pointer-events:none;z-index:9999;mix-blend-mode:screen}
    .cursor-trail{position:fixed;inset:0;pointer-events:none;z-index:9998}
    /* responsive */
    @media (max-width:900px){.sidebar{display:none}.player{max-width:680px;padding:16px}.cover{width:96px;height:96px}}
    /* accessibility focus */
    button:focus,input:focus{outline:2px solid rgba(124,92,255,0.18);outline-offset:2px}
  </style>
</head>
<body>
  <!-- SVG trail + dot -->
  <svg id="cursor-trail" class="cursor-trail" width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none"></svg>
  <div id="cursor-dot" class="cursor-dot" aria-hidden="true"></div>

  <div class="app" role="application" aria-label="Drive music player">
    <!-- Sidebar -->
    <aside class="sidebar" aria-label="Library">
      <div class="brand">
        <div class="logo">DM</div>
        <div>
          <div class="app-title">Drive Music Player</div>
          <div class="muted">Clean player ‚Ä¢ waveform ‚Ä¢ pitch & speed</div>
        </div>
      </div>

      <!-- Quick actions: import/paste tracks JSON, export -->
      <div style="margin-top:12px">
        <label class="muted">Paste tracks JSON (array of objects)</label>
        <textarea id="tracksInput" rows="4" placeholder='[{"name":"Title","artist":"X","url":"https://drive.google.com/uc?export=download&id=FILE_ID","art":""}, ...]'></textarea>
        <div class="controls-row" style="margin-top:8px">
          <button id="loadTracksBtn" class="small">Load tracks</button>
          <button id="clearTracksBtn" class="small ghost">Clear</button>
          <div style="margin-left:auto" class="right-actions">
            <button id="exportBtn" class="small ghost" title="Download tracks.json">Export JSON</button>
          </div>
        </div>
      </div>

      <!-- Search -->
      <div style="margin-top:12px">
        <input id="searchInput" type="search" placeholder="Search songs or artists‚Ä¶" aria-label="Search songs" />
      </div>

      <!-- Song list -->
      <div id="songList" class="song-list" role="list" aria-live="polite" tabindex="0" style="margin-top:10px">
        <!-- songs injected here -->
      </div>

      <!-- bottom controls -->
      <div class="sidebar-footer">
        <div>
          <label style="display:flex;gap:8px;align-items:center"><input id="autoplayToggle" type="checkbox" /> <span class="muted">Autoplay next</span></label>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <button id="shuffleBtn" class="ghost small" title="Shuffle">üîÄ</button>
          <button id="downloadAllBtn" class="ghost small" title="Download tracks.json">‚¨á Export</button>
        </div>
      </div>
    </aside>

    <!-- Main player area -->
    <main class="main">
      <section class="player">
        <div class="player-top">
          <div id="cover" class="cover" aria-hidden="true">‚ô™</div>
          <div class="info">
            <div id="trackName" class="track-name">No track selected</div>
            <div id="trackArtist" class="track-artist">‚Äî</div>
            <div id="sourceLabel" class="muted" style="margin-top:6px">Local playlist</div>
          </div>
        </div>

        <div id="waveform" class="waveform" aria-hidden="true"></div>

        <div class="controls" role="toolbar" aria-label="Player controls">
          <button id="prevBtn" class="small-btn" title="Previous">‚èÆ</button>
          <button id="playBtn" class="large-btn" title="Play / Pause">‚ñ∂</button>
          <button id="nextBtn" class="small-btn" title="Next">‚è≠</button>
        </div>

        <!-- progress -->
        <div class="progress-wrap">
          <div id="progressBar" class="progress" title="Click to seek">
            <div id="progressFill" class="fill"></div>
          </div>
          <div class="time-row">
            <div><span id="currentTime">0:00</span> / <span id="duration">0:00</span></div>
            <div class="muted">Vol: <span id="volVal">90%</span></div>
          </div>
        </div>

        <div class="small-controls">
          <label>Volume
            <input id="volume" type="range" min="0" max="1" step="0.01" value="0.9" />
          </label>

          <label>Speed <output id="speedVal">1.00√ó</output>
            <input id="speed" type="range" min="0.5" max="2" step="0.01" value="1" />
          </label>

          <label>Pitch (semitones) <output id="pitchVal">0</output>
            <input id="pitch" type="range" min="-12" max="12" step="1" value="0" />
            <div class="muted" style="font-size:11px;margin-top:6px">Pitch implemented by playbackRate (tempo also changes). Use a time-stretch/pitch library for pitch-only shifting.</div>
          </label>
        </div>

        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:6px">
          <button id="downloadBtn" class="ghost small">Download track</button>
          <button id="settingsBtn" class="ghost small">Save settings</button>
        </div>

        <div style="height:6px"></div>
        <div class="muted" style="font-size:12px">Keyboard: Space = Play/Pause ‚Ä¢ ‚Üê/‚Üí seek 5s ‚Ä¢ ‚Üë/‚Üì volume</div>
      </section>
    </main>
  </div>

  <!-- WaveSurfer for waveform visualization -->
  <script src="https://unpkg.com/wavesurfer.js"></script>

  <script>
  /*****************************************************************************
   * Clean Drive Music Player
   * - Paste tracks JSON into the textarea, click "Load tracks"
   * - Example item format (the same as you provided):
   *   {
   *     "name": "„ÄêMV„ÄëM@GICAL‚òÜCURE! LOVE ‚ô• SHOT! _ SAWTOWNE feat. Hatsune Miku",
   *     "artist": "questionsandrequestsgalien",
   *     "url": "https://drive.google.com/uc?export=download&id=1v-3HGVhVnmdHZmmhd8Oh9uEjenesNyB3",
   *     "art": ""
   *   }
   *
   * Notes:
   * - This player uses direct download links (drive 'uc?export=download&id=FILE_ID').
   * - If Drive serves a download wrapper, playback typically still works in modern browsers.
   * - Pitch control here modifies playbackRate (tempo changes). Integrate SoundTouch/wavesurfer plugin for tempo-preserving pitch shifts.
   *****************************************************************************/

  /* --- Element helpers --- */
  const $ = id => document.getElementById(id);

  /* --- Cursor + trailing path --- */
  (function cursorTrail(){
    const dot = $('cursor-dot');
    const svg = document.getElementById('cursor-trail');
    const svgNS = "http://www.w3.org/2000/svg";
    const pathEl = document.createElementNS(svgNS, 'path');
    pathEl.setAttribute('stroke', 'rgba(124,92,255,0.22)');
    pathEl.setAttribute('stroke-width', '2');
    pathEl.setAttribute('fill', 'none');
    svg.appendChild(pathEl);

    const POINTS = 14;
    const points = Array.from({length:POINTS}, ()=>({x:window.innerWidth/2,y:window.innerHeight/2}));
    const mouse = {x:window.innerWidth/2,y:window.innerHeight/2};
    window.addEventListener('mousemove', e => { mouse.x = e.clientX; mouse.y = e.clientY; });
    window.addEventListener('touchmove', e => { const t = e.touches[0]; if(t){ mouse.x = t.clientX; mouse.y = t.clientY; } }, {passive:true});

    function lerp(a,b,t){ return a + (b-a)*t; }
    function anim(){
      points[0].x = lerp(points[0].x, mouse.x, 0.22);
      points[0].y = lerp(points[0].y, mouse.y, 0.22);
      for(let i=1;i<POINTS;i++){
        points[i].x = lerp(points[i].x, points[i-1].x, 0.12);
        points[i].y = lerp(points[i].y, points[i-1].y, 0.12);
      }
      // set dot
      dot.style.transform = `translate(${points[0].x}px, ${points[0].y}px) translate(-50%,-50%)`;

      // build smooth path
      let d = `M ${points[0].x} ${points[0].y} `;
      for(let i=1;i<POINTS;i++){
        const prev = points[i-1], cur = points[i];
        const cx = (prev.x + cur.x)/2, cy = (prev.y + cur.y)/2;
        d += `Q ${prev.x} ${prev.y} ${cx} ${cy} `;
      }
      const last = points[POINTS-1];
      d += `T ${last.x} ${last.y}`;
      pathEl.setAttribute('d', d);
      requestAnimationFrame(anim);
    }
    anim();

    // hide on small screens
    if(window.innerWidth < 700){ dot.style.display='none'; svg.style.display='none'; }
  })();

  /* --- WaveSurfer setup --- */
  const wavesurfer = WaveSurfer.create({
    container: '#waveform',
    waveColor: 'rgba(200,200,255,0.10)',
    progressColor: 'rgba(124,92,255,0.35)',
    height: 120,
    normalize: true,
    responsive: true,
    backend: 'MediaElement' // MediaElement can help with cross-origin playback for some hosts
  });

  /* --- Player state --- */
  let tracks = [];           // loaded full track objects (name, artist, url, art)
  let filtered = [];         // after search filter
  let index = -1;
  let shuffleMode = false;

  /* --- DOM refs --- */
  const trackNameEl = $('trackName');
  const trackArtistEl = $('trackArtist');
  const coverEl = $('cover');
  const songListEl = $('songList');

  /* --- Utilities --- */
  function formatTime(s){ if(!isFinite(s)) return '0:00'; s = Math.floor(s); const m = Math.floor(s/60); const sec = s%60; return `${m}:${String(sec).padStart(2,'0')}`; }
  function pitchFactor(semi){ return Math.pow(2, semi/12); }
  function getCombinedRate(){ return parseFloat($('speed').value) * pitchFactor(parseInt($('pitch').value || 0,10)); }

  /* --- Render list and UI updates --- */
  function renderList(list){
    songListEl.innerHTML = '';
    list.forEach((t,i)=>{
      const div = document.createElement('div');
      div.className = 'song';
      div.setAttribute('role','listitem');
      div.innerHTML = `<div class="song-thumb">${t.art ? '' : (t.name ? t.name[0] : '‚ô™')}</div>
                       <div class="song-meta"><div class="song-title">${escapeHtml(t.name)}</div><div class="song-sub">${escapeHtml(t.artist || '')}</div></div>`;
      div.onclick = ()=> playIndex(i);
      songListEl.appendChild(div);
    });
  }

  function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  function updateTrackInfo(t){
    if(!t){ trackNameEl.textContent='No track selected'; trackArtistEl.textContent='‚Äî'; coverEl.textContent='‚ô™'; coverEl.style.backgroundImage=''; $('sourceLabel').textContent='Local playlist'; return; }
    trackNameEl.textContent = t.name;
    trackArtistEl.textContent = t.artist || 'Unknown';
    if(t.art){ coverEl.style.backgroundImage = `url(${t.art})`; coverEl.textContent=''; } else { coverEl.style.backgroundImage=''; coverEl.textContent = (t.name? t.name[0] : '‚ô™'); }
    $('sourceLabel').textContent = t.source || 'Local playlist';
  }

  /* --- Playback controls via wavesurfer --- */
  function playIndex(i){
    if(i<0 || i>=filtered.length) return;
    index = i;
    const t = filtered[index];
    updateTrackInfo(t);
    const url = t.url || `https://drive.google.com/uc?export=download&id=${t.id}`;
    wavesurfer.load(url);
    // ensure we set playback rate after ready
    setTimeout(()=> wavesurfer.setPlaybackRate(getCombinedRate()), 250);
  }

  function playNext(){
    if(filtered.length===0) return;
    if(shuffleMode) playIndex(Math.floor(Math.random()*filtered.length));
    else playIndex((index+1) % filtered.length);
  }
  function playPrev(){ if(filtered.length===0) return; playIndex((index-1+filtered.length) % filtered.length); }

  /* --- wavesurfer event wiring --- */
  wavesurfer.on('ready', ()=>{
    $('duration').textContent = formatTime(wavesurfer.getDuration());
    $('currentTime').textContent = formatTime(0);
    // auto-play when loaded if play button was active or autoplay setting
    if(localStorage.getItem('drivePlayerAutoPlayOnLoad') === 'true' || $('autoplayToggle').checked) wavesurfer.play();
  });
  wavesurfer.on('audioprocess', ()=>{ const cur = wavesurfer.getCurrentTime(); $('currentTime').textContent = formatTime(cur); const dur = wavesurfer.getDuration()||1; $('progressFill').style.width = ((cur/dur)*100)+'%'; });
  wavesurfer.on('seek', ()=>{ const cur = wavesurfer.getCurrentTime(); $('currentTime').textContent = formatTime(cur); });
  wavesurfer.on('finish', ()=>{ if($('autoplayToggle').checked) playNext(); else updatePlayBtn(); });
  wavesurfer.on('play', updatePlayBtn);
  wavesurfer.on('pause', updatePlayBtn);

  function updatePlayBtn(){ $('playBtn').textContent = wavesurfer.isPlaying() ? '‚è∏' : '‚ñ∂'; }

  /* --- UI controls wiring --- */
  $('playBtn').addEventListener('click', ()=> { if(wavesurfer.isPlaying()) wavesurfer.pause(); else wavesurfer.play(); updatePlayBtn(); });
  $('prevBtn').addEventListener('click', playPrev);
  $('nextBtn').addEventListener('click', playNext);

  $('progressBar').addEventListener('click', (e)=>{
    const rect = $('progressBar').getBoundingClientRect();
    const pct = (e.clientX - rect.left) / rect.width;
    wavesurfer.seekTo(Math.max(0, Math.min(1, pct)));
  });

  $('volume').addEventListener('input', ()=>{
    const v = parseFloat($('volume').value);
    if(typeof wavesurfer.setVolume === 'function') wavesurfer.setVolume(v);
    $('volVal').textContent = Math.round(v*100)+'%';
    localStorage.setItem('drivePlayerVolume', $('volume').value);
  });

  $('speed').addEventListener('input', ()=>{
    $('speedVal').textContent = parseFloat($('speed').value).toFixed(2)+'√ó';
    wavesurfer.setPlaybackRate(getCombinedRate());
    localStorage.setItem('drivePlayerSpeed', $('speed').value);
  });

  $('pitch').addEventListener('input', ()=>{
    $('pitchVal').textContent = parseInt($('pitch').value,10);
    wavesurfer.setPlaybackRate(getCombinedRate());
    localStorage.setItem('drivePlayerPitch', $('pitch').value);
  });

  $('shuffleBtn').addEventListener('click', ()=>{ shuffleMode = !shuffleMode; $('shuffleBtn').style.opacity = shuffleMode? '1' : '0.6'; });
  $('clearTracksBtn').addEventListener('click', ()=>{ tracks=[]; filtered=[]; renderList(filtered); wavesurfer.empty(); updateTrackInfo(null); });

  $('downloadBtn').addEventListener('click', ()=>{
    if(index<0 || !filtered[index]) return;
    const t = filtered[index];
    const url = t.url || `https://drive.google.com/uc?export=download&id=${t.id}`;
    const a = document.createElement('a'); a.href = url; a.download = t.name || 'track'; document.body.appendChild(a); a.click(); a.remove();
  });

  $('downloadAllBtn').addEventListener('click', ()=> $('exportBtn').click());

  /* --- Import / Export tracks JSON --- */
  $('loadTracksBtn').addEventListener('click', ()=>{
    const raw = $('tracksInput').value.trim();
    if(!raw) { alert('Paste a JSON array of tracks into the textarea first.'); return; }
    try {
      const arr = JSON.parse(raw);
      if(!Array.isArray(arr)) throw new Error('JSON must be an array');
      // basic validation and normalization
      tracks = arr.map(item => ({
        name: item.name || item.title || 'Untitled',
        artist: item.artist || item.author || '',
        url: item.url || item.streamUrl || '',
        art: item.art || '',
        source: item.source || 'local'
      })).filter(t => typeof t.url === 'string' && t.url.length > 0);
      filtered = tracks.slice();
      renderList(filtered);
      // save to localStorage
      localStorage.setItem('drivePlayerTracks', JSON.stringify(tracks));
      if(tracks.length) playIndex(0);
    } catch(e){
      alert('Invalid JSON: '+ e.message);
      console.error(e);
    }
  });

  // export
  $('exportBtn').addEventListener('click', ()=>{
    const data = JSON.stringify(tracks.map(t => ({ name:t.name, artist:t.artist, url:t.url, art:t.art })), null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'tracks.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  });

  /* --- Search --- */
  $('searchInput').addEventListener('input', ()=>{
    const q = $('searchInput').value.trim().toLowerCase();
    filtered = tracks.filter(t => (t.name||'').toLowerCase().includes(q) || (t.artist||'').toLowerCase().includes(q));
    renderList(filtered);
  });

  /* --- Keyboard shortcuts --- */
  window.addEventListener('keydown', (e) => {
    if(e.code === 'Space'){ e.preventDefault(); $('playBtn').click(); }
    if(e.key === 'ArrowLeft'){ wavesurfer.skip(-5); }
    if(e.key === 'ArrowRight'){ wavesurfer.skip(5); }
    if(e.key === 'ArrowUp'){ const v = Math.min(1, parseFloat($('volume').value)+0.05); $('volume').value = v; $('volume').dispatchEvent(new Event('input')); }
    if(e.key === 'ArrowDown'){ const v = Math.max(0, parseFloat($('volume').value)-0.05); $('volume').value = v; $('volume').dispatchEvent(new Event('input')); }
  });

  /* --- Persist settings & initial load --- */
  function saveSettings(){
    const s = {
      volume: $('volume').value,
      speed: $('speed').value,
      pitch: $('pitch').value,
      autoplay: $('autoplayToggle').checked,
      tracks: tracks
    };
    localStorage.setItem('drivePlayerSettings', JSON.stringify(s));
  }
  window.addEventListener('beforeunload', saveSettings);
  $('settingsBtn').addEventListener('click', saveSettings);

  function loadSaved(){
    const raw = localStorage.getItem('drivePlayerSettings');
    if(raw){
      try {
        const s = JSON.parse(raw);
        if(s.volume) $('volume').value = s.volume;
        if(s.speed) $('speed').value = s.speed;
        if(s.pitch) $('pitch').value = s.pitch;
        if(s.autoplay) $('autoplayToggle').checked = s.autoplay;
        if(Array.isArray(s.tracks) && s.tracks.length){
          tracks = s.tracks;
          filtered = tracks.slice();
          renderList(filtered);
          // fill textarea for visibility
          $('tracksInput').value = JSON.stringify(tracks, null, 2);
        }
      } catch(e){ console.warn('Failed to load settings', e); }
    }
    // also load older tracks storage key if present
    try {
      const rawTracks = localStorage.getItem('drivePlayerTracks');
      if(rawTracks && !tracks.length){
        tracks = JSON.parse(rawTracks);
        filtered = tracks.slice();
        renderList(filtered);
        $('tracksInput').value = JSON.stringify(tracks, null, 2);
      }
    } catch(e){}
    // apply volume
    wavesurfer.setVolume(parseFloat($('volume').value || 0.9));
    $('volVal').textContent = Math.round(parseFloat($('volume').value || 0.9)*100)+'%';
    $('speedVal').textContent = parseFloat($('speed').value||1).toFixed(2)+'√ó';
    $('pitchVal').textContent = parseInt($('pitch').value||0,10);
  }
  loadSaved();

  /* --- Small helper: when wavesurfer not playing, clicking first track toggles play --- */
  // Not needed but keep UX friendly.

  /* --- Provide example track prefilled using the format you supplied --- */
  (function seedExample(){
    // Only set example if no tracks loaded
    if(tracks.length===0){
      const example = {
        "name": "„ÄêMV„ÄëM@GICAL‚òÜCURE! LOVE ‚ô• SHOT! _ SAWTOWNE feat. Hatsune Miku",
        "artist": "questionsandrequestsgalien",
        "url": "https://drive.google.com/uc?export=download&id=1v-3HGVhVnmdHZmmhd8Oh9uEjenesNyB3",
        "art": ""
      };
      tracks = [example];
      filtered = tracks.slice();
      renderList(filtered);
      $('tracksInput').value = JSON.stringify(tracks, null, 2);
      // Do not auto-play by default; user clicks play
      updateTrackInfo(tracks[0]);
    }
  })();

  /* expose some helpers for debugging in console */
  window.playerDebug = {
    wavesurfer, playIndex, playNext, playPrev, getTracks: ()=>tracks, setTracks: t=>{ tracks=t; filtered=tracks.slice(); renderList(filtered); }
  };
  </script>
</body>
</html>
