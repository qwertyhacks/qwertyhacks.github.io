<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Drive Music Player ‚Äî Auto-scan + Waveform</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg: #081018;
      --panel: rgba(255,255,255,0.03);
      --accent: #7c5cff;
      --muted: #9aa4b2;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: linear-gradient(180deg,var(--bg), #051018);
      color:#e6eefb;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      overflow:hidden;
    }

    /* layout */
    .app {
      display:flex;
      height:100vh;
      gap:20px;
      padding:20px;
      align-items:stretch;
    }

    /* SIDEBAR */
    .sidebar {
      width:320px;
      max-width:36%;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:14px;
      padding:14px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.6);
      display:flex;
      flex-direction:column;
      transition: transform .25s ease;
    }

    .sidebar.collapsed{ transform: translateX(-340px); }

    .sidebar-head {
      display:flex;
      gap:10px;
      align-items:center;
    }
    .title {
      font-weight:700;
      font-size:18px;
    }
    .control-row{
      display:flex;
      gap:8px;
      margin-top:10px;
    }
    input[type="text"], input[type="search"] {
      width:100%;
      padding:8px 10px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,0.03);
      background: rgba(255,255,255,0.02);
      color:inherit;
      outline:none;
    }
    button {
      background: linear-gradient(135deg,var(--accent), #3aa1ff);
      border: none;
      color: white;
      padding:8px 12px;
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
    }
    button.ghost {
      background: transparent;
      border:1px solid rgba(255,255,255,0.06);
    }
    .muted { color:var(--muted); font-size:13px }

    .song-list {
      margin-top:12px;
      overflow:auto;
      padding-right:6px;
      flex:1;
    }
    .song {
      padding:10px;
      border-radius:10px;
      margin-bottom:8px;
      cursor:pointer;
      display:flex;
      gap:10px;
      align-items:center;
      transition: transform .12s ease, background .12s ease;
      background: transparent;
    }
    .song:hover {
      transform: translateY(-3px);
      background: linear-gradient(90deg, rgba(124,92,255,0.04), rgba(124,92,255,0.02));
    }
    .song-thumb {
      width:44px;
      height:44px;
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:var(--muted);
      font-weight:700;
      background: rgba(255,255,255,0.02);
      flex-shrink:0;
    }
    .song-meta .sname { font-weight:700 }
    .song-meta .sartist { font-size:12px; color:var(--muted) }

    .sidebar-footer {
      margin-top:10px;
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
    }

    /* MAIN */
    .main {
      flex:1;
      display:flex;
      align-items:center;
      justify-content:center;
      height:100%;
    }
    .player {
      width:100%;
      max-width:920px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:14px;
      padding:20px;
      box-shadow: 0 30px 60px rgba(0,0,0,0.6);
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .player-top {
      display:flex;
      gap:16px;
      align-items:center;
    }
    .art {
      width:110px;
      height:110px;
      border-radius:12px;
      background:linear-gradient(135deg,var(--accent), #3aa1ff);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      font-size:24px;
      color:white;
      flex-shrink:0;
    }
    .info {
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .track-title { font-weight:800; font-size:20px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    .track-artist { color:var(--muted); font-size:13px }

    .controls {
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:center;
    }
    .big-btn {
      padding:12px 18px;
      border-radius:12px;
      border:none;
      font-size:16px;
      cursor:pointer;
      background: linear-gradient(135deg,var(--accent), #3aa1ff);
      color:white;
      box-shadow: 0 10px 30px rgba(124,92,255,0.12);
    }

    .progress {
      height:12px;
      background: rgba(255,255,255,0.03);
      border-radius:999px;
      overflow:hidden;
      cursor:pointer;
    }
    .progress .fill {
      height:100%;
      width:0%;
      background: linear-gradient(90deg, var(--accent), #3aa1ff);
      transition: width .06s linear;
    }
    .time-row {
      display:flex;
      justify-content:space-between;
      color:var(--muted);
      font-size:13px;
    }

    .small-controls {
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .small-controls label { display:flex; gap:8px; align-items:center; font-size:13px }

    .waveform {
      height:130px;
      margin-top:6px;
    }

    /* custom cursor + trail */
    .cursor-dot{
      position:fixed;
      top:0;
      left:0;
      width:12px;
      height:12px;
      border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff, var(--accent));
      box-shadow: 0 8px 24px rgba(124,92,255,0.18);
      transform: translate(-50%,-50%) scale(1);
      pointer-events:none;
      z-index:9999;
      mix-blend-mode:screen;
    }
    .cursor-trail{
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:9998;
    }

    /* responsive */
    @media (max-width:980px){
      .sidebar{ width:260px }
    }
    @media (max-width:820px){
      .app{ padding:12px }
      .sidebar{ position:fixed; left:0; top:12px; bottom:12px; z-index:20; transform:translateX(0); }
      .sidebar.collapsed{ transform:translateX(-360px) }
    }
  </style>

  <!-- WaveSurfer (visual waveform) -->
  <script src="https://unpkg.com/wavesurfer.js"></script>
</head>
<body>
  <svg id="cursor-trail" class="cursor-trail" width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none"></svg>
  <div class="cursor-dot" id="cursor-dot" aria-hidden="true"></div>

  <div class="app">
    <aside id="sidebar" class="sidebar">
      <div class="sidebar-head">
        <div>
          <div class="title">Library</div>
          <div class="muted">Auto-scan Google Drive folder</div>
        </div>
        <div style="margin-left:auto">
          <button id="toggleSidebar" class="ghost" title="Collapse sidebar">‚ò∞</button>
        </div>
      </div>

      <div style="margin-top:10px">
        <input id="folderInput" type="text" placeholder="Drive Folder ID (or full folder URL)" />
        <div style="height:8px"></div>
        <input id="apiInput" type="text" placeholder="Google API Key (client-side - consider restricting)" />
        <div style="height:8px"></div>
        <div class="control-row">
          <button id="scanBtn">Refresh Songs</button>
          <button id="exportBtn" class="ghost">Export tracks.json</button>
        </div>
        <div style="height:8px"></div>
        <input id="searchInput" type="search" placeholder="Search songs or artists‚Ä¶" />
        <div style="height:10px"></div>
        <div class="muted">Tip: restrict API key to Drive API and your domain in Google Cloud Console, or use a proxy to hide the key.</div>
      </div>

      <div class="song-list" id="songList" aria-live="polite" role="list"></div>

      <div class="sidebar-footer">
        <label><input type="checkbox" id="autoplayToggle" /> Autoplay next</label>
        <div style="display:flex; gap:8px; align-items:center;">
          <button id="shuffleBtn" class="ghost" title="Shuffle">üîÄ</button>
          <button id="clearBtn" class="ghost" title="Clear list">üóë</button>
        </div>
      </div>
    </aside>

    <main class="main">
      <div class="player" role="application" aria-label="Music player">
        <div class="player-top">
          <div id="art" class="art">‚ô™</div>
          <div class="info">
            <div id="title" class="track-title">No song selected</div>
            <div id="artist" class="track-artist">‚Äî</div>
            <div class="muted" id="sourceHint">No source</div>
          </div>
        </div>

        <div id="waveform" class="waveform"></div>

        <div class="controls">
          <button id="prevBtn" class="big-btn">‚èÆ</button>
          <button id="playBtn" class="big-btn">‚ñ∂</button>
          <button id="nextBtn" class="big-btn">‚è≠</button>
        </div>

        <div class="progress" id="progressBar" title="Click to seek">
          <div class="fill" id="progressFill"></div>
        </div>
        <div class="time-row">
          <div><span id="currentTime">0:00</span> / <span id="duration">0:00</span></div>
          <div class="muted">Volume: <span id="volVal">90%</span></div>
        </div>

        <div class="small-controls">
          <label>Volume
            <input id="volume" type="range" min="0" max="1" step="0.01" value="0.9">
          </label>

          <label>Speed <output id="speedVal">1.00√ó</output>
            <input id="speed" type="range" min="0.5" max="2" step="0.01" value="1">
          </label>

          <label>Pitch (semitones) <output id="pitchVal">0</output>
            <input id="pitch" type="range" min="-12" max="12" step="1" value="0">
          </label>
        </div>

        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:6px;">
          <button id="downloadBtn" class="ghost">Download current track</button>
          <button id="settingsBtn" class="ghost">Settings</button>
        </div>

        <div style="height:6px"></div>
        <div class="muted" style="font-size:12px">Keyboard: Space=Play/Pause ‚Ä¢ ‚Üê/‚Üí seek 5s ‚Ä¢ ‚Üë/‚Üì volume</div>
      </div>
    </main>
  </div>

  <script>
  /* ========== Utilities ========== */
  const $ = (id) => document.getElementById(id);

  function saveSettings() {
    const o = {
      folder: $('folderInput').value || '',
      apiKey: $('apiInput').value || '',
      autoplay: $('autoplayToggle').checked,
      volume: $('volume').value,
      speed: $('speed').value,
      pitch: $('pitch').value
    };
    localStorage.setItem('drivePlayerSettings', JSON.stringify(o));
  }
  function loadSettings() {
    const raw = localStorage.getItem('drivePlayerSettings');
    if (raw) {
      try {
        const o = JSON.parse(raw);
        $('folderInput').value = o.folder || '';
        $('apiInput').value = o.apiKey || '';
        $('autoplayToggle').checked = !!o.autoplay;
        if (o.volume) $('volume').value = o.volume;
        if (o.speed) $('speed').value = o.speed;
        if (o.pitch) $('pitch').value = o.pitch;
      } catch (e) {}
    }
  }

  function extractFolderId(s) {
    if (!s) return '';
    s = s.trim();
    // match the typical Drive folder/file id (lengthy alphanum - allow 25+)
    const m = s.match(/[-\w]{25,}/);
    if (m) return m[0];
    return s;
  }

  function fmt(s) {
    if (!isFinite(s)) return '0:00';
    s = Math.floor(s);
    const m = Math.floor(s / 60);
    const sec = s % 60;
    return `${m}:${String(sec).padStart(2, '0')}`;
  }

  /* ========== Drive listing (paginated, encoded query) ========== */
  async function listDriveFiles(folderId, apiKey) {
    const files = [];
    let pageToken = null;
    const base = 'https://www.googleapis.com/drive/v3/files';
    const fields = 'nextPageToken,files(id,name,mimeType,owners(displayName),modifiedTime)';
    do {
      const url = new URL(base);
      const q = `'${folderId}' in parents and trashed = false`;
      url.searchParams.set('q', q);
      url.searchParams.set('fields', fields);
      url.searchParams.set('pageSize', '1000');
      if (pageToken) url.searchParams.set('pageToken', pageToken);
      url.searchParams.set('key', apiKey);

      // Use encodeURIComponent for 'q' param handled by URLSearchParams automatically,
      // but we ensure the final url is valid.
      const resp = await fetch(url.toString());
      if (!resp.ok) {
        const txt = await resp.text();
        const err = new Error('Drive API error: ' + resp.status + ' ‚Äî ' + txt);
        err.status = resp.status;
        throw err;
      }
      const data = await resp.json();
      if (data.files && Array.isArray(data.files)) files.push(...data.files);
      pageToken = data.nextPageToken || null;
    } while (pageToken);
    return files;
  }

  /* ========== App state & WaveSurfer setup ========== */
  let trackList = [];
  let filteredList = [];
  let currentIndex = -1;
  let shuffleMode = false;

  const wavesurfer = WaveSurfer.create({
    container: '#waveform',
    waveColor: 'rgba(200,200,255,0.12)',
    progressColor: 'rgba(124,92,255,0.35)',
    height: 120,
    responsive: true,
    normalize: true,
    backend: 'MediaElement' // try MediaElement for better Drive compatibility
  });

  wavesurfer.on('ready', () => {
    $('duration').textContent = fmt(wavesurfer.getDuration());
    updateProgress();
    if (localStorage.getItem('drivePlayerAutoplayOnLoad') === 'true' && $('autoplayToggle').checked) {
      wavesurfer.play();
      updatePlayButton();
    }
  });
  wavesurfer.on('audioprocess', updateProgress);
  wavesurfer.on('seek', updateProgress);
  wavesurfer.on('finish', onTrackEnd);
  wavesurfer.on('play', updatePlayButton);
  wavesurfer.on('pause', updatePlayButton);

  function renderList(list) {
    const el = $('songList');
    el.innerHTML = '';
    list.forEach((t, i) => {
      const div = document.createElement('div');
      div.className = 'song';
      div.setAttribute('role', 'listitem');
      div.innerHTML = `
        <div class="song-thumb">${(t.art ? '' : (t.name ? t.name[0] : '‚ô™'))}</div>
        <div class="song-meta">
          <div class="sname">${t.name}</div>
          <div class="sartist">${t.artist || ''}</div>
        </div>
      `;
      div.onclick = () => playIndex(i);
      el.appendChild(div);
    });
  }

  function updateTrackInfo(track) {
    if (!track) {
      $('title').textContent = 'No song selected';
      $('artist').textContent = '‚Äî';
      $('art').textContent = '‚ô™';
      $('sourceHint').textContent = 'No source';
    } else {
      $('title').textContent = track.name;
      $('artist').textContent = track.artist || 'Unknown';
      if (track.art) {
        $('art').style.backgroundImage = `url(${track.art})`;
        $('art').textContent = '';
      } else {
        $('art').style.backgroundImage = '';
        $('art').textContent = (track.name ? track.name[0] : '‚ô™');
      }
      $('sourceHint').textContent = (track.source || '').startsWith('drive') ? 'Google Drive' : track.source || '';
    }
  }

  /* ========== Playback controls ========== */
  function playIndex(i) {
    if (i < 0 || i >= filteredList.length) return;
    currentIndex = i;
    const t = filteredList[i];
    updateTrackInfo(t);
    const url = t.url || `https://drive.google.com/uc?export=download&id=${t.id}`;
    // some Drive links require setting crossOrigin; using MediaElement backend helps
    wavesurfer.load(url);
    // set combined playbackRate after ready (small timeout safe-guard)
    setTimeout(() => {
      wavesurfer.setPlaybackRate(getCombinedPlaybackRate());
    }, 300);
    updatePlayButton();
  }

  function playNext() {
    if (filteredList.length === 0) return;
    if (shuffleMode) {
      const r = Math.floor(Math.random() * filteredList.length);
      playIndex(r);
    } else {
      let n = (currentIndex + 1) % filteredList.length;
      playIndex(n);
    }
  }

  function playPrev() {
    if (filteredList.length === 0) return;
    let p = (currentIndex - 1 + filteredList.length) % filteredList.length;
    playIndex(p);
  }

  function onTrackEnd() {
    if ($('autoplayToggle').checked) playNext();
    else updatePlayButton();
  }

  function updateProgress() {
    const dur = wavesurfer.getDuration() || 1;
    const cur = wavesurfer.getCurrentTime() || 0;
    const pct = Math.min(100, (cur / dur) * 100);
    $('progressFill').style.width = pct + '%';
    $('currentTime').textContent = fmt(cur);
    $('duration').textContent = fmt(dur);
  }

  function updatePlayButton() {
    const el = $('playBtn');
    el.textContent = wavesurfer.isPlaying() ? '‚è∏' : '‚ñ∂';
  }

  /* ========== Search & UI interactions ========== */
  $('searchInput').addEventListener('input', () => {
    const q = $('searchInput').value.trim().toLowerCase();
    filteredList = trackList.filter(t => (t.name || '').toLowerCase().includes(q) || (t.artist || '').toLowerCase().includes(q));
    renderList(filteredList);
  });

  $('progressBar').addEventListener('click', (e) => {
    const rect = $('progressBar').getBoundingClientRect();
    const pct = (e.clientX - rect.left) / rect.width;
    wavesurfer.seekTo(Math.max(0, Math.min(1, pct)));
    updateProgress();
  });

  $('scanBtn').addEventListener('click', async () => { await doScanAndBuild(); });
  $('exportBtn').addEventListener('click', () => {
    const data = JSON.stringify(trackList.map(t => ({
      name: t.name,
      artist: t.artist || 'Unknown',
      url: t.url || `https://drive.google.com/uc?export=download&id=${t.id}`,
      art: t.art || ''
    })), null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'tracks.json';
    a.click();
    URL.revokeObjectURL(url);
  });

  $('playBtn').addEventListener('click', () => {
    if (wavesurfer.isPlaying()) wavesurfer.pause();
    else wavesurfer.play();
    updatePlayButton();
  });
  $('prevBtn').addEventListener('click', playPrev);
  $('nextBtn').addEventListener('click', playNext);

  $('volume').addEventListener('input', () => {
    const v = parseFloat($('volume').value);
    if (typeof wavesurfer.setVolume === 'function') wavesurfer.setVolume(v);
    $('volVal').textContent = Math.round(v * 100) + '%';
    localStorage.setItem('drivePlayerVolume', $('volume').value);
  });

  $('speed').addEventListener('input', () => {
    const v = parseFloat($('speed').value);
    $('speedVal').textContent = v.toFixed(2) + '√ó';
    wavesurfer.setPlaybackRate(getCombinedPlaybackRate());
    localStorage.setItem('drivePlayerSpeed', $('speed').value);
  });

  function pitchFactorFromSemitones(semi) { return Math.pow(2, semi / 12); }

  $('pitch').addEventListener('input', () => {
    const s = parseInt($('pitch').value, 10);
    $('pitchVal').textContent = s;
    wavesurfer.setPlaybackRate(getCombinedPlaybackRate());
    localStorage.setItem('drivePlayerPitch', $('pitch').value);
  });

  function getCombinedPlaybackRate() {
    const speed = parseFloat($('speed').value || 1);
    const semitones = parseFloat($('pitch').value || 0);
    const pitchFactor = pitchFactorFromSemitones(semitones);
    return speed * pitchFactor;
  }

  $('autoplayToggle').addEventListener('change', saveSettings);
  $('shuffleBtn').addEventListener('click', () => {
    shuffleMode = !shuffleMode;
    $('shuffleBtn').style.opacity = shuffleMode ? '1' : '0.6';
  });
  $('clearBtn').addEventListener('click', () => {
    trackList = []; filteredList = []; renderList(filteredList);
    wavesurfer.empty(); updateTrackInfo(null);
  });

  $('downloadBtn').addEventListener('click', () => {
    if (currentIndex < 0 || !filteredList[currentIndex]) return;
    const t = filteredList[currentIndex];
    const url = t.url || `https://drive.google.com/uc?export=download&id=${t.id}`;
    const a = document.createElement('a');
    a.href = url;
    a.download = t.name || 'track';
    a.click();
  });

  $('toggleSidebar').addEventListener('click', () => { $('sidebar').classList.toggle('collapsed'); });

  window.addEventListener('keydown', (e) => {
    if (e.code === 'Space') { e.preventDefault(); $('playBtn').click(); }
    if (e.key === 'ArrowLeft') { wavesurfer.skip(-5); updateProgress(); }
    if (e.key === 'ArrowRight') { wavesurfer.skip(5); updateProgress(); }
    if (e.key === 'ArrowUp') { const v = Math.min(1, parseFloat($('volume').value) + 0.05); $('volume').value = v; $('volume').dispatchEvent(new Event('input')); }
    if (e.key === 'ArrowDown') { const v = Math.max(0, parseFloat($('volume').value) - 0.05); $('volume').value = v; $('volume').dispatchEvent(new Event('input')); }
  });

  /* ========== Scan + build playlist ========== */
  async function doScanAndBuild() {
    saveSettings();
    const rawFolder = $('folderInput').value.trim();
    const rawKey = $('apiInput').value.trim();
    if (!rawFolder || !rawKey) { alert('Please provide folder ID (or URL) and API key.'); return; }
    const folderId = extractFolderId(rawFolder);
    const apiKey = rawKey;
    $('songList').innerHTML = '<div class="muted">Scanning folder‚Ä¶</div>';
    try {
      const files = await listDriveFiles(folderId, apiKey);
      const audioFiles = files.filter(f => {
        if (!f.name || !f.mimeType) return false;
        const name = f.name.toLowerCase();
        return f.mimeType.startsWith('audio/') || name.endsWith('.mp3') || name.endsWith('.m4a') || name.endsWith('.wav') || name.endsWith('.ogg');
      }).map(f => ({
        id: f.id,
        name: f.name.replace(/\.[^/.]+$/, ''),
        mimeType: f.mimeType,
        artist: (f.owners && f.owners[0] && f.owners[0].displayName) || '',
        modified: f.modifiedTime,
        url: `https://drive.google.com/uc?export=download&id=${f.id}`,
        source: 'drive'
      }));

      audioFiles.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));
      trackList = audioFiles;
      filteredList = trackList.slice();
      renderList(filteredList);

      if (trackList.length > 0) {
        playIndex(0);
      } else {
        alert('No audio files found in folder. Make sure files are shared (Anyone with link can view).');
        $('songList').innerHTML = '<div class="muted">No audio files found.</div>';
      }
    } catch (err) {
      console.error(err);
      alert('Error scanning folder: ' + (err.message || err));
      $('songList').innerHTML = '<div class="muted">Error scanning folder.</div>';
    }
  }

  /* ========== Cursor + trail animation ========== */
  (function cursorTrail() {
    const cursorDot = $('cursor-dot');
    const svg = document.getElementById('cursor-trail');
    const svgNS = "http://www.w3.org/2000/svg";
    const pathEl = document.createElementNS(svgNS, 'path');
    pathEl.setAttribute('stroke', 'rgba(124,92,255,0.25)');
    pathEl.setAttribute('stroke-width', '2');
    pathEl.setAttribute('fill', 'none');
    svg.appendChild(pathEl);

    const POINTS = 12;
    const points = [];
    for (let i = 0; i < POINTS; i++) points.push({ x: window.innerWidth / 2, y: window.innerHeight / 2 });
    let mouse = { x: window.innerWidth / 2, y: window.innerHeight / 2 };
    window.addEventListener('mousemove', (e) => { mouse.x = e.clientX; mouse.y = e.clientY; });
    window.addEventListener('touchmove', (e) => { const t = e.touches[0]; if (t) { mouse.x = t.clientX; mouse.y = t.clientY; } }, { passive: true });

    function lerp(a, b, t) { return a + (b - a) * t; }
    function animate() {
      points[0].x = lerp(points[0].x, mouse.x, 0.2);
      points[0].y = lerp(points[0].y, mouse.y, 0.2);
      for (let i = 1; i < POINTS; i++) {
        points[i].x = lerp(points[i].x, points[i - 1].x, 0.12);
        points[i].y = lerp(points[i].y, points[i - 1].y, 0.12);
      }
      cursorDot.style.transform = `translate(${points[0].x}px, ${points[0].y}px) translate(-50%,-50%)`;
      let d = `M ${points[0].x} ${points[0].y} `;
      for (let i = 1; i < points.length; i++) {
        const prev = points[i - 1];
        const cur = points[i];
        const cx = (prev.x + cur.x) / 2;
        const cy = (prev.y + cur.y) / 2;
        d += `Q ${prev.x} ${prev.y} ${cx} ${cy} `;
      }
      const last = points[points.length - 1];
      d += `T ${last.x} ${last.y}`;
      pathEl.setAttribute('d', d);
      requestAnimationFrame(animate);
    }
    animate();

    // hide on small screens
    if (window.innerWidth < 700) { cursorDot.style.display = 'none'; svg.style.display = 'none'; }

    // hide while focusing inputs
    ['focusin', 'focusout'].forEach(ev => {
      window.addEventListener(ev, (e) => {
        if (ev === 'focusin' && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) {
          cursorDot.style.display = 'none'; svg.style.display = 'none';
        } else if (ev === 'focusout') {
          cursorDot.style.display = ''; svg.style.display = '';
        }
      }, true);
    });
  })();

  /* ========== Init: load settings & wire up ========== */
  loadSettings();
  // apply saved volume/speed/pitch
  $('volume').value = localStorage.getItem('drivePlayerVolume') || $('volume').value;
  $('speed').value = localStorage.getItem('drivePlayerSpeed') || $('speed').value;
  $('pitch').value = localStorage.getItem('drivePlayerPitch') || $('pitch').value;
  $('speedVal').textContent = $('speed').value + '√ó';
  $('pitchVal').textContent = $('pitch').value;
  $('volVal').textContent = Math.round(parseFloat($('volume').value) * 100) + '%';
  wavesurfer.setVolume(parseFloat($('volume').value || 0.9));
  saveSettings();

  // optionally auto-scan if settings present & user wants it (disabled by default)
  (async () => {
    const s = JSON.parse(localStorage.getItem('drivePlayerSettings') || '{}');
    if (s && s.folder && s.apiKey && localStorage.getItem('drivePlayerAutoScan') === 'true') {
      await doScanAndBuild();
    }
  })();

  // expose for debug
  window.drivePlayer = { doScanAndBuild, listDriveFiles, trackList, filteredList, playIndex };
  </script>
</body>
</html>
