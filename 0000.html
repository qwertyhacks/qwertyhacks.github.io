<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Python Web Terminal</title>
<script src="https://cdn.jsdelivr.net/pyodide/v0.26.2/full/pyodide.js"></script>
<style>
body {
  background:#111;
  margin:0;
  overflow:hidden;
  font-family:monospace;
}

#window {
  position:absolute;
  top:60px;
  left:60px;
  width:800px;
  height:500px;
  background:black;
  border:1px solid #0f0;
  display:flex;
  flex-direction:column;
}

#titlebar {
  background:#111;
  padding:6px;
  cursor:move;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid #0f0;
  color:#0f0;
}

#menuButton {
  cursor:pointer;
  padding:2px 6px;
  border:1px solid #0f0;
}

#menu {
  position:absolute;
  top:35px;
  right:10px;
  background:#000;
  border:1px solid #0f0;
  display:none;
  flex-direction:column;
  z-index:9999;
  min-width:180px;
}

#menu button {
  background:none;
  border:none;
  color:#0f0;
  padding:6px;
  text-align:left;
  cursor:pointer;
}

#menu button:hover {
  background:#003300;
}

#terminal {
  flex:1;
  padding:10px;
  overflow-y:auto;
  white-space:pre-wrap;
  color:#0f0;
}

#input {
  border:none;
  outline:none;
  padding:8px;
  background:black;
  color:#0f0;
  font-family:monospace;
  font-size:14px;
  width:100%;
}

.hidden { display:none; }
</style>
</head>
<body>

<div id="window">
  <div id="titlebar">
    <div>Python Web Terminal</div>
    <div id="menuButton">Menu â–¾</div>
  </div>

  <div id="menu">
    <button id="uploadBtn">Upload Python File</button>
    <button id="saveBtn">Save File (save name.py)</button>
    <button id="downloadBtn">Download File</button>
    <button id="clearBtn">Clear Terminal</button>
    <button id="themeBtn">Toggle Theme</button>
  </div>

  <div id="terminal">Loading Python runtime...</div>
  <input id="input" autocomplete="off" autofocus />
</div>

<input type="file" id="fileInput" class="hidden" accept=".py"/>

<script>
let pyodide;
let term = document.getElementById("terminal");
let input = document.getElementById("input");
let menu = document.getElementById("menu");
let themeState = 0;

async function init(){
  pyodide = await loadPyodide();

  await pyodide.runPythonAsync(`
import sys, code, os
from js import write_output

class Writer:
    def write(self, s): write_output(s)
    def flush(self): pass

sys.stdout = Writer()
sys.stderr = Writer()

console = code.InteractiveConsole()
`);

  write_output("Python ready.\n>>> ");
}

function write_output(text){
  term.textContent += text;
  term.scrollTop = term.scrollHeight;
}

async function runCommand(cmd){
  term.textContent += cmd + "\n";
  await pyodide.runPythonAsync(`
console.push("""${cmd.replace(/\\/g,"\\\\").replace(/`/g,"\\`")}""")
`);
}

input.addEventListener("keydown", async e=>{
  if(e.key==="Enter"){
    let cmd=input.value;
    input.value="";
    await runCommand(cmd);
  }
});

document.getElementById("menuButton").onclick=()=>{
  menu.style.display = menu.style.display==="flex"?"none":"flex";
};

document.getElementById("clearBtn").onclick=()=>{
  term.textContent="";
  write_output(">>> ");
  menu.style.display="none";
};

document.getElementById("uploadBtn").onclick=()=>{
  document.getElementById("fileInput").click();
  menu.style.display="none";
};

document.getElementById("fileInput").addEventListener("change", async e=>{
  let file=e.target.files[0];
  if(!file)return;
  let text=await file.text();
  write_output("\n# Running "+file.name+"\n");
  await pyodide.runPythonAsync(text);
  write_output("\n>>> ");
});

document.getElementById("saveBtn").onclick=()=>{
  write_output("\nUse: save filename.py\n>>> ");
  menu.style.display="none";
};

document.getElementById("downloadBtn").onclick=()=>{
  let name=prompt("Enter filename to download:");
  if(!name)return;
  try{
    let data=pyodide.FS.readFile(name,{encoding:"utf8"});
    let blob=new Blob([data],{type:"text/plain"});
    let a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=name;
    a.click();
  }catch{
    alert("File not found.");
  }
  menu.style.display="none";
};

document.getElementById("themeBtn").onclick=()=>{
  themeState=(themeState+1)%3;
  let colors=[["#0f0","black"],["#fff","#111"],["#ffb000","black"]];
  term.style.color=colors[themeState][0];
  input.style.color=colors[themeState][0];
  document.getElementById("window").style.borderColor=colors[themeState][0];
  document.getElementById("titlebar").style.borderBottomColor=colors[themeState][0];
  document.getElementById("titlebar").style.color=colors[themeState][0];
  menu.style.borderColor=colors[themeState][0];
  menu.querySelectorAll("button").forEach(b=>b.style.color=colors[themeState][0]);
  menu.style.display="none";
};

// draggable window
let win=document.getElementById("window");
let title=document.getElementById("titlebar");
let offsetX,offsetY,isDown=false;

title.addEventListener("mousedown",e=>{
  isDown=true;
  offsetX=e.clientX-win.offsetLeft;
  offsetY=e.clientY-win.offsetTop;
});
document.addEventListener("mouseup",()=>isDown=false);
document.addEventListener("mousemove",e=>{
  if(!isDown)return;
  win.style.left=(e.clientX-offsetX)+"px";
  win.style.top=(e.clientY-offsetY)+"px";
});

init();
</script>

</body>
</html>
